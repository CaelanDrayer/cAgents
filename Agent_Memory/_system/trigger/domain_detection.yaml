# Domain Detection Configuration
# Context-aware domain detection with confidence scoring, minimum tier 2 enforcement
# Updated for V7.5+ super-domain structure
description: "Context-aware domain detection with keyword, project structure, git history, and framework detection"

# CRITICAL: All requests are tier 2+ (always use specialist agents)
minimum_tier: 2
enforcement: strict
reason: "All requests benefit from multi-agent specialist coverage"

# V7.5+ SUPER-DOMAIN MAPPING
# 5 super-domains: make, grow, operate, people, serve
super_domains:
  make: "Creation capability (engineering, creative, product, game development)"
  grow: "Acquisition capability (marketing, sales)"
  operate: "Operations capability (finance, operations)"
  people: "Talent capability (HR, culture)"
  serve: "Support & Governance (customer experience, legal, compliance)"

# DETECTION METHODS (Weighted)
detection_methods:
  # Method 1: Keyword-Based Detection (30% weight)
  keyword_based:
    weight: 0.3
    description: "Traditional keyword matching from user request"
    patterns:
      # MAKE super-domain (engineering + creative + product)
      make:
        keywords: [code, fix, bug, api, test, deploy, refactor, implement, build, debug, error, crash, feature, backend, frontend, database, server, story, novel, character, write, plot, chapter, scene, dialogue, narrative, worldbuilding, fiction, poem, prose, wording, rewrite, rephrase, copy, text improvement, edit text, revise, polish, copywriting, tone, phrasing, product, design, ux, ui, game, level, graphics, animation, audio]
        confidence_boost: 0.15

      # GROW super-domain (marketing + sales)
      grow:
        keywords: [sales, forecast, pipeline, revenue, deal, CRM, marketing, campaign, launch, content, brand, SEO, demand, conversion, leads, acquisition, funnel, growth]
        confidence_boost: 0.15

      # OPERATE super-domain (finance + operations)
      operate:
        keywords: [budget, expense, ROI, P&L, cashflow, FP&A, financial, cost, spending, profit, loss, accounting, operations, supply chain, inventory, logistics, procurement]
        confidence_boost: 0.15

      # PEOPLE super-domain (HR + culture)
      people:
        keywords: [recruit, onboard, talent, compensation, culture, HR, hiring, employee, team, performance, feedback, training, development, engagement]
        confidence_boost: 0.15

      # SERVE super-domain (customer experience + legal + compliance)
      serve:
        keywords: [customer, support, ticket, help desk, SLA, satisfaction, feedback, retention, churn, service, contract, compliance, IP, policy, regulatory, legal, GDPR, audit, risk, governance]
        confidence_boost: 0.15

      universal:
        keywords: [analyze, report, document, review, plan, strategy, workflow, process]
        confidence_boost: 0.10

  # Method 2: Context-Based Detection (40% weight)
  context_based:
    weight: 0.4
    description: "Project structure, files, and configuration analysis"

    project_structure:
      # Package managers and config files -> MAKE
      - file: package.json
        indicates: [make]
        confidence_boost: 0.20
        check_contents: true
        patterns:
          - keyword: '"react"'
            framework: react
            boost: 0.10
          - keyword: '"next"'
            framework: nextjs
            boost: 0.10
          - keyword: '"vue"'
            framework: vue
            boost: 0.10
          - keyword: '"@angular"'
            framework: angular
            boost: 0.10

      - file: requirements.txt
        indicates: [make]
        confidence_boost: 0.20
        check_contents: true
        patterns:
          - keyword: django
            framework: django
            boost: 0.10
          - keyword: fastapi
            framework: fastapi
            boost: 0.10
          - keyword: flask
            framework: flask
            boost: 0.10

      - file: composer.json
        indicates: [make]
        confidence_boost: 0.20
        check_contents: true
        patterns:
          - keyword: laravel
            framework: laravel
            boost: 0.10

      - file: pom.xml
        indicates: [make]
        confidence_boost: 0.20
        framework: java_spring

      - file: Gemfile
        indicates: [make]
        confidence_boost: 0.20
        check_contents: true
        patterns:
          - keyword: rails
            framework: rails
            boost: 0.10

      - file: go.mod
        indicates: [make]
        confidence_boost: 0.20
        framework: golang

      - file: Cargo.toml
        indicates: [make]
        confidence_boost: 0.20
        framework: rust

      # Documentation and content -> MAKE (creative)
      - file: docs/
        indicates: [universal, make]
        confidence_boost: 0.10

      - pattern: "*.md"
        count_threshold: 10
        indicates: [make, universal]
        confidence_boost: 0.15

      # Build and deployment -> MAKE (engineering) + OPERATE
      - file: Dockerfile
        indicates: [make, operate]
        confidence_boost: 0.15

      - file: docker-compose.yml
        indicates: [make, operate]
        confidence_boost: 0.15

      - file: terraform/
        indicates: [make, operate]
        confidence_boost: 0.20

      - file: .github/workflows/
        indicates: [make]
        confidence_boost: 0.15

      # Marketing and sales -> GROW
      - file: campaigns/
        indicates: [grow]
        confidence_boost: 0.20

      - file: content/
        indicates: [grow, make]
        confidence_boost: 0.15

      # Finance -> OPERATE
      - pattern: "*budget*.xlsx"
        indicates: [operate]
        confidence_boost: 0.25

      - pattern: "*forecast*.csv"
        indicates: [operate, grow]
        confidence_boost: 0.20

    git_history:
      enabled: true
      recent_commits: 20
      analysis:
        - pattern: "fix.*auth"
          indicates: make
          confidence_boost: 0.15

        - pattern: "add.*feature"
          indicates: make
          confidence_boost: 0.12

        - pattern: "update.*docs"
          indicates: [universal, make]
          confidence_boost: 0.10

        - pattern: "campaign.*"
          indicates: grow
          confidence_boost: 0.15

        - pattern: "budget.*"
          indicates: operate
          confidence_boost: 0.15

        - pattern: "hire.*|onboard.*"
          indicates: people
          confidence_boost: 0.15

    file_type_distribution:
      thresholds:
        - types: [".js", ".ts", ".tsx", ".jsx"]
          count_threshold: 10
          indicates: make
          confidence_boost: 0.20

        - types: [".py"]
          count_threshold: 5
          indicates: make
          confidence_boost: 0.20

        - types: [".md", ".txt"]
          count_threshold: 20
          indicates: make
          confidence_boost: 0.15

        - types: [".tf"]
          count_threshold: 3
          indicates: make
          confidence_boost: 0.20

  # Method 3: Framework Detection (30% weight)
  framework_detection:
    weight: 0.3
    description: "Detect specific frameworks and technologies"

    frameworks:
      - name: nextjs
        indicators:
          - file: next.config.js
          - file: next.config.mjs
          - directory: app/
          - directory: pages/
        domains: [make]
        confidence: 0.90
        boost_if_found: 0.25

      - name: react
        indicators:
          - package_keyword: '"react"'
          - file_pattern: "*.jsx"
          - file_pattern: "*.tsx"
        domains: [make]
        confidence: 0.85
        boost_if_found: 0.20

      - name: vue
        indicators:
          - package_keyword: '"vue"'
          - file_pattern: "*.vue"
        domains: [make]
        confidence: 0.85
        boost_if_found: 0.20

      - name: angular
        indicators:
          - file: angular.json
          - package_keyword: '"@angular"'
        domains: [make]
        confidence: 0.90
        boost_if_found: 0.25

      - name: django
        indicators:
          - file: manage.py
          - file: settings.py
          - package_keyword: django
        domains: [make]
        confidence: 0.90
        boost_if_found: 0.25

      - name: fastapi
        indicators:
          - package_keyword: fastapi
          - file_pattern: "*main.py"
        domains: [make]
        confidence: 0.85
        boost_if_found: 0.20

      - name: flask
        indicators:
          - package_keyword: flask
          - file_pattern: "app.py"
        domains: [make]
        confidence: 0.80
        boost_if_found: 0.15

      - name: express
        indicators:
          - package_keyword: '"express"'
          - file_pattern: "*server.js"
        domains: [make]
        confidence: 0.80
        boost_if_found: 0.15

      - name: rails
        indicators:
          - file: Gemfile
          - gem_keyword: rails
          - file: config/routes.rb
        domains: [make]
        confidence: 0.90
        boost_if_found: 0.25

      - name: laravel
        indicators:
          - file: artisan
          - file: composer.json
          - composer_keyword: laravel
        domains: [make]
        confidence: 0.90
        boost_if_found: 0.25

# INTENT CLASSIFICATION
intent_classification:
  description: "Classify user intent beyond domain detection"

  patterns:
    - intent: bug_fix
      keywords: [fix, bug, issue, error, broken, crash, fail, problem]
      confidence: 0.85
      typical_tier: 2
      workflow_template: bug_fix
      specialists: [developer, qa-lead]

    - intent: feature
      keywords: [add, implement, create, new, build, develop]
      confidence: 0.80
      typical_tier: 3
      workflow_template: feature_addition
      specialists: [developer, architect, qa-lead]

    - intent: refactor
      keywords: [refactor, clean, optimize, restructure, reorganize]
      confidence: 0.75
      typical_tier: 3
      workflow_template: code_refactor
      specialists: [developer, architect]
      notes: "Code-specific refactoring (not content editing)"

    - intent: question
      keywords: [how, what, why, explain, describe, tell me]
      confidence: 0.90
      typical_tier: 2
      workflow_template: expert_answer
      specialists: [domain-expert, researcher]
      notes: "Questions routed to domain experts for comprehensive answers"

    - intent: analysis
      keywords: [analyze, review, assess, evaluate, audit, examine]
      confidence: 0.80
      typical_tier: 2
      workflow_template: analysis_request
      specialists: [analyst, domain-expert]

    - intent: documentation
      keywords: [document, write docs, readme, guide, tutorial]
      confidence: 0.85
      typical_tier: 2
      workflow_template: documentation_creation
      specialists: [technical-writer, developer]

    - intent: content_creation
      keywords: [write, story, novel, blog, article, content, copy]
      confidence: 0.85
      typical_tier: 2
      workflow_template: content_creation
      specialists: [copywriter, editor]

    - intent: content_editing
      keywords: [improve wording, update wording, rewrite, rephrase, better wording, edit text, revise text, polish text, make it sound, word it, change the wording, fix wording, improve the text, update the text, edit copy, revise copy, improve copy, improve]
      confidence: 0.85
      typical_tier: 2
      workflow_template: content_creation
      specialists: [copywriter, editor]
      notes: "Routes to make domain (creative) with copywriter/editor specialists"

    - intent: planning
      keywords: [plan, strategy, roadmap, OKR, goals, objectives]
      confidence: 0.80
      typical_tier: 2
      workflow_template: strategic_planning
      specialists: [strategist, analyst]

    - intent: testing
      keywords: [test, coverage, spec, validate, verify]
      confidence: 0.85
      typical_tier: 2
      workflow_template: testing_workflow
      specialists: [qa-lead, developer]

    - intent: simple_edit
      keywords: [typo, spelling, grammar, small change, quick fix, minor]
      confidence: 0.80
      typical_tier: 2
      workflow_template: code_review
      specialists: [developer, reviewer]
      notes: "Even minor edits benefit from quality review"

# MULTI-DOMAIN DETECTION
multi_domain:
  description: "Detect when request spans multiple domains"
  threshold: 0.6

  patterns:
    - keywords: [GDPR, compliance, implementation]
      domains: [serve, make, people]
      confidence: 0.85

    - keywords: [product launch, campaign]
      domains: [grow, make]
      confidence: 0.80

    - keywords: [employee onboarding, system access]
      domains: [people, make]
      confidence: 0.80

    - keywords: [financial reporting, dashboard]
      domains: [operate, make]
      confidence: 0.85

    - keywords: [customer feedback, feature request]
      domains: [serve, make]
      confidence: 0.80

# CONFIDENCE THRESHOLDS
confidence_thresholds:
  auto_proceed: 0.7
  ask_user: 0.7
  suggest_alternatives: 0.5
  escalate_to_hitl: 0.5

  description: |
    - >= 0.7: Auto-proceed with domain (high confidence)
    - 0.5-0.7: Ask user to confirm domain with top 3 candidates
    - < 0.5: Escalate to HITL (unable to determine domain confidently)

# AMBIGUITY DETECTION
ambiguity_detection:
  enabled: true
  description: "Detect ambiguous requests requiring user clarification"

  triggers:
    - multiple_domains_above_threshold: 0.6
      action: present_alternatives

    - highest_confidence_below: 0.7
      action: ask_user_confirm

    - conflicting_signals:
        example: "keywords suggest make, project structure suggests grow"
        action: ask_user_clarify

  user_prompt_template: |
    I detected multiple possible domains for your request:

    {domain_1}: {confidence_1}% confidence
    {domain_2}: {confidence_2}% confidence
    {domain_3}: {confidence_3}% confidence

    Which domain is most relevant?

# HISTORICAL LEARNING
historical_learning:
  enabled: true
  description: "Learn from past workflows to improve future detection"

  tracking:
    - track_user_corrections: true
    - track_workflow_success: true
    - track_tier_accuracy: true

  adjustment:
    - user_corrected_domain:
        action: boost_actual_domain
        boost_amount: 0.10
        decay_rate: 0.95

    - workflow_failed:
        action: reduce_domain_confidence
        reduction: 0.05

    - workflow_succeeded:
        action: boost_domain_confidence
        boost_amount: 0.02

  storage:
    file: Agent_Memory/_knowledge/calibration/domain_detection_history.yaml
    max_entries: 1000
    retention_days: 180

# SCORING ALGORITHM
scoring_algorithm:
  description: "How to calculate final domain confidence score"

  formula: |
    final_score = (
      keyword_score * keyword_weight +
      context_score * context_weight +
      framework_score * framework_weight
    ) + historical_adjustment

  weights:
    keyword: 0.3
    context: 0.4
    framework: 0.3

  normalization:
    min: 0.0
    max: 1.0

  example:
    request: "Fix authentication bug in Next.js app"
    keyword_score: 0.80
    context_score: 0.90
    framework_score: 0.90
    historical_adjustment: 0.05
    final_score: 0.92
    classification: make (high confidence)
